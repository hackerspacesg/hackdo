{% extends 'base.html' %}
{% load humanize%}
{% block header %}
{% include "tools/nav_bar.html" %}
{% endblock header %}
{% block content %}
<article id="user_profile">
<section id="account_summary" class="hero-unit">
<header><h4>Account summary</h4></header>
<ul id="account_details">
    <li><span class="detail_header">Member since</span> <span class="detail_value">{% if u.member_since %}{{ u.member_since|date:"M Y" }}{% else %}-N/A-{% endif %}</span></li>
    <li><span class="detail_header">Membership status</span> <span class="detail_value {% if account_balance >= 0.0 %}positive{% else %}negative{% endif %}">{% if u.membership_status %}{{ u.membership_status }}{% else %}-N/A-{% endif %}</span></li>
    <li><span class="detail_header">Paid to date</span> <span class="detail_value currency">{{ paid_to_date|intcomma }}</span></li>
    <li><span class="detail_header">Overall balance</span> <span class="detail_value balance currency {% if account_balance >= 0.0 %}positive{% else %}negative{% endif %}">{{ account_balance|intcomma }}</span></li>
</ul>
</section>
<hr/>
<section id="contract_summaries" class="row">
<div class="span12">
    <header><h4>Contracts</h4></header>
    {% regroup contracts by ctype as contract_list %}
    <ul id="user_contracts">
        {% for contract in contract_list %}
        <li class="contract_type">
        {{ contract.grouper }}
        <ul>
            {% for c in contract.list %}
            <li class="contract">
            {{ c }} &mdash; <span title="Contract balance" class="balance currency {% if c.balance >= 0.0 %}positive{% else %}negative{% endif %}">{{ c.balance }}</span>
            </li>
            {% endfor %}
        </ul>
        </li>
        {% empty %}
        <li class="placeholder">No contracts found</li>
        {% endfor %}
    </ul>
</div>
</section>
<hr/>
<section id="payment_submission" class="row well">
<div class="span12">
{% if contract_list %}
    <header><h4>Submit a new Payment</h4></header>
    <form method="post" action="{% url "user_profile" u.username %}" class="form-horizontal">
        {% csrf_token %}
        {{ pform.media }}
        {% for field in pform %}
        <div class="control-group {% if field.errors %}error{% endif %}">
            <label for="id_{{field.name}}" class="control-label">{{ field.label }}</label>
            <div class="controls">
            {% if field.name == 'date_paid'%}
            <div class="datepicker input-append">
                <input name="{{field.name}}" data-format="yyyy-MM-dd" type="text"></input>
                <span class="add-on">
                    <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                </span>
            </div>
            <span class="help-inline">{{ field.errors }}</span>
            {% else %}
                {{ field }}
                <span class="help-inline">{{ field.errors }}</span>
            {% endif %}
            </div>
        </div>
        {% endfor %}
        <input class="btn btn-primary" type="submit" value="Notify admins of new payment">
    </form>
{% else %}
    <header><h4>You need a contract before you can make payment.</h4></header>
{% endif %}
</div>
</section>
<hr/>
<section id="payment_history" class="row">
<div class="span12">
    <header><h4>Payment history</h4></header>
    <table id="payment_history_table" class="table table-striped">
        <thead>
            <tr>
                <th>Date</th>
                <th>Amount (SGD)</th>
                <th>Contract</th>
                <th>Method</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            {% for p in payment_history %}
            <tr class="
                {% if p.verified %}
                success
                {% else %}
                warning
                {% endif %}
                ">
                <td>{{ p.date_paid }}</td>
                <td>{{ p.amount }}</td>
                <td>{{ p.contract }}</td>
                <td>{{ p.get_method_display }}</td>
                <td>{{ p.desc }}</td>
            </tr>
            {% empty %}
            <tr class="payment placeholder">
                <td colspan="5">No payments found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="legend">
        <span class="legend_block"></span> <span class="legend_text">verified payments</span>
    </div>
</div>
</section>
</article>
{% endblock content %}
